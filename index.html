<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=0.4.5.2" />






<meta name="description" content="生命不息，折腾不止！！！">
<meta property="og:type" content="website">
<meta property="og:title" content="Shine's blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Shine's blog">
<meta property="og:description" content="生命不息，折腾不止！！！">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shine's blog">
<meta name="twitter:description" content="生命不息，折腾不止！！！">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'hide',
    motion: true
  };
</script>

  <title> Shine's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6e3e65b6fa6d46bfec86b332d7db0bcb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i class="" style="transform: translateX(100%);"></i></span>
      <span class="site-title">Shine's blog</span>
      <span class="logo-line-after"><i class="" style="transform: translateX(-100%);"></i></span>
    </a>
  </div>
  <p class="site-subtitle">生命不息，折腾不止！！！</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            目录
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      
        
        
        
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/14/礼物动画/" itemprop="url">
                  直播礼物动画
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2017-04-14T12:21:09+08:00" content="2017-04-14">
              2017-04-14
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/14/礼物动画/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/14/礼物动画/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>最近在做直播礼物，需要展示礼物动画，调研的方案有 帧动画，gif，apng，视频，webp</p>
<h1 id="png_u5E27_u52A8_u753B"><a href="#png_u5E27_u52A8_u753B" class="headerlink" title="png帧动画"></a>png帧动画</h1><h2 id="png"><a href="#png" class="headerlink" title="png"></a>png</h2><p>诞生在 1995 年，比 JPEG 晚几年。它本身的设计目的是替代 GIF 格式，所以它与 GIF 有更多相似的地方。PNG 只支持无损压缩，所以它的压缩比是有上限的。相对于 JPEG 和 GIF 来说，它最大的优势在于支持完整的透明通道。</p>
<h2 id="AnimationDrawable"><a href="#AnimationDrawable" class="headerlink" title="AnimationDrawable"></a>AnimationDrawable</h2><p>通过AnimationDrawable播放帧动画，主动recycle，释放bitmap</p>
<p>主要代码<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> initAnim(<span class="keyword">final</span> Context context) &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(dirPath)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AssetManager assetManager = context.getAssets();</span><br><span class="line">            <span class="keyword">String</span>[] framePaths = assetManager.list(dirPath);</span><br><span class="line">            <span class="built_in">int</span> frameDuration = duration != <span class="number">0</span> ? duration / framePaths.length : FRAME_DURATION;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">String</span> frame : framePaths) &#123;</span><br><span class="line">                <span class="keyword">String</span> framePath = dirPath + <span class="string">"/"</span> + frame;</span><br><span class="line">                Bitmap frameBmp = BitmapFactory.decodeStream(assetManager.<span class="built_in">open</span>(framePath));</span><br><span class="line">                addFrame(<span class="keyword">new</span> BitmapDrawable(context.getResources(), frameBmp), frameDuration);</span><br><span class="line">            &#125;</span><br><span class="line">            addFrame(getFrame(<span class="number">0</span>), <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> recycle() &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(dirPath)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dirPath = <span class="keyword">null</span>;</span><br><span class="line">        setCallback(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (isRunning()) &#123;</span><br><span class="line">            stop();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//            setCallback(new Drawable.Callback() &#123;</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public void invalidateDrawable(@NonNull Drawable who) &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public void scheduleDrawable(@NonNull Drawable who, @NonNull Runnable what, long when) &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public void unscheduleDrawable(@NonNull Drawable who, @NonNull Runnable what) &#123;</span></span><br><span class="line"><span class="comment">//                    setCallback(null);</span></span><br><span class="line"><span class="comment">//                    destroyBitmap();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;);</span></span><br><span class="line"><span class="comment">//        &#125; else &#123;</span></span><br><span class="line"><span class="comment">//            setCallback(null);</span></span><br><span class="line"><span class="comment">//            destroyBitmap();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> destroyBitmap() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; getNumberOfFrames(); i++) &#123;</span><br><span class="line">                Drawable frame = getFrame(i);</span><br><span class="line">                <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> BitmapDrawable) &#123;</span><br><span class="line">                    Bitmap bmp = ((BitmapDrawable) frame).getBitmap();</span><br><span class="line">                    <span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; !bmp.isRecycled()) &#123;</span><br><span class="line">                        bmp.recycle();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                frame.setCallback(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setCallback(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>遇到的问题</li>
</ul>
<ol>
<li>性能问题：内存开销大，播放一个全屏动画（10帧，750p），内存涨了40MB,gc频繁</li>
<li>释放问题：为了避免OOM，动画执行完后，主动释放bitmap，调用stop后动画仍在绘制，导致抛异常，加回调后，部分机型仍会抛异常。</li>
<li>稳定性：由于自己封装，边界问题考虑不是很好，容易卡死。</li>
<li>文件太大</li>
</ol>
<h1 id="gif"><a href="#gif" class="headerlink" title="gif"></a>gif</h1><p>诞生于 1987 年，随着初代互联网流行开来。它有很多缺点，比如通常情况下只支持 256 种颜色、透明通道只有 1 bit、文件压缩比不高。它唯一的优势就是支持多帧动画，凭借这个特性，它得以从 Windows 1.0 时代流行至今，而且仍然大受欢迎。</p>
<ul>
<li>优点 ：</li>
</ul>
<ol>
<li>制作简单</li>
<li>文件小</li>
</ol>
<ul>
<li>缺点</li>
</ul>
<ol>
<li>锯齿，边界模糊</li>
</ol>
<h1 id="u89C6_u9891"><a href="#u89C6_u9891" class="headerlink" title="视频"></a>视频</h1><p>主要问题是，背景不可以透明，播放器开销大，稳定性</p>
<h1 id="apng"><a href="#apng" class="headerlink" title="apng"></a>apng</h1><p>是 Mozilla 在 2008 年发布的一种图片格式，旨在替换掉画质低劣的 GIF 动画。它实际上只是相当于 PNG 格式的一个扩展，所以 Mozilla 一直想把它合并到 PNG 标准里面去。然而 PNG 开发组并没有接受 APNG 这个扩展，而是一直在推进它自己的 MNG 动图格式。MNG 格式过于复杂以至于并没有什么系统或浏览器支持，而 APNG 格式由于简单容易实现，目前已经渐渐流行开来。Mozilla 自己的 Firefox 首先支持了 APNG，随后苹果的 Safari 也开始有了支持， Chrome 目前也已经尝试开始支持 ，可以说未来前景很好。</p>
<p>没有找到很好的播放库</p>
<h1 id="WebP"><a href="#WebP" class="headerlink" title="WebP"></a>WebP</h1><p><a href="https://developers.google.cn/speed/webp/" target="_blank" rel="external">WebP</a>是 Google 在 2010 年发布的图片格式，希望以更高的压缩比替代 JPEG。它用 VP8 视频帧内编码作为其算法基础，取得了不错的压缩效果。它支持有损和无损压缩、支持完整的透明通道、也支持多帧动画，并且没有版权问题，是一种非常理想的图片格式。借由 Google 在网络世界的影响力，WebP 在几年的时间内已经得到了广泛的应用。看看你手机里的 App：微博、微信、QQ、淘宝、网易新闻等等，每个 App 里都有 WebP 的身影。Facebook 则更进一步，用 WebP 来显示聊天界面的贴纸动画。</p>
<ul>
<li>制作webp动画</li>
</ul>
<ol>
<li>在官网下载转换工作</li>
<li><p>把png转为webp<br>转换命令，q为质量</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cwebp -<span class="tag">q</span> <span class="number">50</span> -lossless picture<span class="class">.png</span> -o picture_lossless.webp</span><br></pre></td></tr></table></figure>
</li>
<li><p>把webp系列图转为webp动画<br>转换命令，+b会把所有帧重叠，-b不重叠</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpmux -frame <span class="number">1.</span>webp +<span class="number">100</span> -frame <span class="number">2.</span>webp +<span class="number">100</span>+<span class="number">50</span>+<span class="number">50</span> -frame <span class="number">3.</span>webp +<span class="number">100</span>+<span class="number">50</span>+<span class="number">50</span>+<span class="number">1</span>+b -loop <span class="number">10</span> -bgcolor <span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span> -o anim_container.webp</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>目前只发现了通过命令转换，很不方便，改一个参数就需要重新输命令，于是请同学写了一个Python脚本，在此感谢@黎潇大神。<br>Python代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">rootdir = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> subdir, dirs, files <span class="keyword">in</span> os.walk(rootdir):</span><br><span class="line">    <span class="keyword">if</span> subdir.startswith(<span class="string">'.'</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    webps = []</span><br><span class="line">    <span class="keyword">for</span> fname <span class="keyword">in</span> files:</span><br><span class="line">        fpath = os.path.join(subdir, fname)</span><br><span class="line">        l = fname.split(<span class="string">'.'</span>)</span><br><span class="line">        l[-<span class="number">1</span>] = <span class="string">'webp'</span></span><br><span class="line">        pattern = re.compile(<span class="string">r'\d+'</span>)</span><br><span class="line">        result =  re.search(pattern, fpath)</span><br><span class="line">        opath = os.path.join(subdir, <span class="string">'.'</span>.join(l))</span><br><span class="line">        <span class="keyword">if</span> fname.startswith(<span class="string">'.'</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        os.system(<span class="string">'cwebp %s -q 85 -o %s'</span> % (fpath, opath) )</span><br><span class="line">        webps.append(opath)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'webps: '</span>, len(webps)</span><br><span class="line">    <span class="keyword">if</span> len(webps) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    opts = <span class="string">''</span></span><br><span class="line">    opath = os.path.join(rootdir, subdir+<span class="string">'.webp'</span>)</span><br><span class="line">    <span class="keyword">for</span> fname <span class="keyword">in</span> webps:</span><br><span class="line">        opts += <span class="string">' -frame '</span> + fname +  <span class="string">' +140+0+0+0-b'</span></span><br><span class="line">    </span><br><span class="line">    opts += <span class="string">' -frame '</span> + webps[<span class="number">0</span>] + <span class="string">' +0+0+0+0-b'</span></span><br><span class="line">    os.system(<span class="string">'webpmux %s -loop 1 -o %s'</span> % (opts, opath))</span><br></pre></td></tr></table></figure></p>
<ul>
<li>来源<a href="http://blog.ibireme.com/2015/11/02/mobile_image_benchmark/" target="_blank" rel="external">移动端图片格式调研</a></li>
</ul>
<h1 id="u4F7F_u7528fresco_u52A0_u8F7DGIF_u548Cwebp"><a href="#u4F7F_u7528fresco_u52A0_u8F7DGIF_u548Cwebp" class="headerlink" title="使用fresco加载GIF和webp"></a>使用fresco加载GIF和webp</h1><h2 id="gradle_u6DFB_u52A0_u4F9D_u8D56"><a href="#gradle_u6DFB_u52A0_u4F9D_u8D56" class="headerlink" title="gradle添加依赖"></a>gradle添加依赖</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'com.facebook.fresco:fresco:1.2.0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//gif 支持</span></span><br><span class="line"><span class="keyword">compile</span> <span class="string">'com.facebook.fresco:animated-gif:1.2.0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//webp动画支持</span></span><br><span class="line"><span class="keyword">compile</span> <span class="string">'com.facebook.fresco:animated-webp:1.2.0'</span></span><br></pre></td></tr></table></figure>
<h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><ol>
<li><p>自动播放</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Uri</span> uri;</span><br><span class="line">DraweeController controller = Fresco.newDraweeControllerBuilder()</span><br><span class="line">    .setUri(uri)</span><br><span class="line">    .setAutoPlayAnimations(<span class="keyword">true</span>)</span><br><span class="line">    . <span class="comment">// 其他设置（如果有的话）</span></span><br><span class="line">    .build();</span><br><span class="line">mSimpleDraweeView.setController(controller);</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动播放</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ControllerListener controllerListener = <span class="keyword">new</span> BaseControllerListener&lt;ImageInfo&gt;() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public <span class="keyword">void</span> onFinalImageSet(</span><br><span class="line">        <span class="built_in">String</span> id,</span><br><span class="line">        <span class="annotation">@Nullable</span> ImageInfo imageInfo,</span><br><span class="line">        <span class="annotation">@Nullable</span> Animatable anim) &#123;</span><br><span class="line">        <span class="keyword">if</span> (anim != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 其他控制逻辑</span></span><br><span class="line">          anim.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Uri</span> uri;</span><br><span class="line">DraweeController controller = Fresco.newDraweeControllerBuilder()</span><br><span class="line">    .setUri(uri)</span><br><span class="line">    .setControllerListener(controllerListener)</span><br><span class="line">    <span class="comment">// 其他设置（如果有的话）</span></span><br><span class="line">    .build();</span><br><span class="line">mSimpleDraweeView.setController(controller);</span><br></pre></td></tr></table></figure></li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/07/line-intersect-rect/" itemprop="url">
                  判断直线与矩形相交
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2017-03-07T10:15:18+08:00" content="2017-03-07">
              2017-03-07
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/03/07/line-intersect-rect/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/07/line-intersect-rect/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> Rectangle &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final <span class="keyword">int</span> OUT_LEFT = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final <span class="keyword">int</span> OUT_TOP = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final <span class="keyword">int</span> OUT_RIGHT = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final <span class="keyword">int</span> OUT_BOTTOM = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> width;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> height;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> left;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> top;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rectangle</span><span class="params">(<span class="keyword">float</span> x1, <span class="keyword">float</span> y1, <span class="keyword">float</span> w, <span class="keyword">float</span> h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.left = x1;</span><br><span class="line">        <span class="keyword">this</span>.top = y1;</span><br><span class="line">        width = w;</span><br><span class="line">        height = h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> boolean <span class="title">intersectsLine</span><span class="params">(<span class="keyword">float</span> x1, <span class="keyword">float</span> y1, <span class="keyword">float</span> x2, <span class="keyword">float</span> y2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> out1, out2;</span><br><span class="line">        <span class="keyword">if</span> ((out2 = outcode(x2, y2)) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ((out1 = outcode(x1, y1)) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((out1 &amp; out2) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((out1 &amp; (OUT_LEFT | OUT_RIGHT)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">float</span> x = left;</span><br><span class="line">                <span class="keyword">if</span> ((out1 &amp; OUT_RIGHT) != <span class="number">0</span>) &#123;</span><br><span class="line">                    x += width;</span><br><span class="line">                &#125;</span><br><span class="line">                y1 = y1 + (x - x1) * (y2 - y1) / (x2 - x1);</span><br><span class="line">                x1 = x;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">float</span> y = top;</span><br><span class="line">                <span class="keyword">if</span> ((out1 &amp; OUT_BOTTOM) != <span class="number">0</span>) &#123;</span><br><span class="line">                    y += height;</span><br><span class="line">                &#125;</span><br><span class="line">                x1 = x1 + (y - y1) * (x2 - x1) / (y2 - y1);</span><br><span class="line">                y1 = y;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">outcode</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> out = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.width &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            out |= OUT_LEFT | OUT_RIGHT;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="keyword">this</span>.left) &#123;</span><br><span class="line">            out |= OUT_LEFT;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; <span class="keyword">this</span>.left + <span class="keyword">this</span>.width) &#123;</span><br><span class="line">            out |= OUT_RIGHT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.height &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            out |= OUT_TOP | OUT_BOTTOM;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y &lt; <span class="keyword">this</span>.top) &#123;</span><br><span class="line">            out |= OUT_TOP;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y &gt; <span class="keyword">this</span>.top + <span class="keyword">this</span>.height) &#123;</span><br><span class="line">            out |= OUT_BOTTOM;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/06/Android-数据库/" itemprop="url">
                  Android 数据库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2017-02-06T18:20:28+08:00" content="2017-02-06">
              2017-02-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/06/Android-数据库/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/06/Android-数据库/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p> NiceApplication.getApplication().getContentResolver().applyBatch()<br>        ContentProviderOperation.newInsert().withValues().build()</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/13/downlaod-unzip/" itemprop="url">
                  断点下载与解压ZIP
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2017-01-13T16:05:24+08:00" content="2017-01-13">
              2017-01-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/13/downlaod-unzip/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/13/downlaod-unzip/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="u521D_u59CB_u5316"><a href="#u521D_u59CB_u5316" class="headerlink" title="初始化"></a>初始化</h1><p>获取文件大小，已下载文件大小<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> init() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(httpUrl);</span><br><span class="line">        HttpURLConnection connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">        connection.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">        connection.setRequestMethod(<span class="string">"GET"</span>);</span><br><span class="line">        fileSize = connection.getContentLength();</span><br><span class="line">        connection.disconnect();</span><br><span class="line"></span><br><span class="line">        Context context = NiceApplication.getApplication().getApplicationContext();</span><br><span class="line">        <span class="keyword">File</span> fileDir = StorageUtils.getIndividualFileDirectory(context, <span class="string">"nice-lens-resource"</span>);</span><br><span class="line">        rootDir = fileDir.getAbsolutePath();</span><br><span class="line">        <span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(fileDir, fileName + <span class="string">".zip"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">file</span>.exists()) &#123;</span><br><span class="line">            <span class="keyword">file</span>.createNewFile();</span><br><span class="line">            completeSize = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            completeSize = <span class="keyword">file</span>.length();</span><br><span class="line">        &#125;</span><br><span class="line">        zipFilePath = <span class="keyword">file</span>.getAbsolutePath();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="u65AD_u70B9_u4E0B_u8F7D"><a href="#u65AD_u70B9_u4E0B_u8F7D" class="headerlink" title="断点下载"></a>断点下载</h1><p>设置http头，指定下载开始和结束点，”Range”-&gt;”bytes=startPosi-endPosi”<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">download</span>(<span class="params"></span>) throws Exception </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (completeSize == fileSize) &#123;</span><br><span class="line">           <span class="keyword">return</span> zipFilePath;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       HttpURLConnection connection;</span><br><span class="line">       RandomAccessFile randomAccessFile;</span><br><span class="line">       InputStream <span class="keyword">is</span>;</span><br><span class="line">       URL url = <span class="keyword">new</span> URL(httpUrl);</span><br><span class="line">       connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">       connection.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">       connection.setRequestMethod(<span class="string">"GET"</span>);</span><br><span class="line">       <span class="comment">// 设置范围，格式为Range：bytes x-y;</span></span><br><span class="line">       connection.setRequestProperty(<span class="string">"Range"</span>, String.format(<span class="string">"bytes=%s-%s"</span>, completeSize, fileSize));</span><br><span class="line"></span><br><span class="line">       randomAccessFile = <span class="keyword">new</span> RandomAccessFile(zipFilePath, <span class="string">"rwd"</span>);</span><br><span class="line">       randomAccessFile.seek(completeSize);</span><br><span class="line">       <span class="keyword">is</span> = connection.getInputStream();</span><br><span class="line">       <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">       <span class="keyword">int</span> length;</span><br><span class="line">       <span class="keyword">while</span> ((length = <span class="keyword">is</span>.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">           randomAccessFile.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">           completeSize += length;</span><br><span class="line">           update();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> zipFilePath;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="u89E3_u538Bzip"><a href="#u89E3_u538Bzip" class="headerlink" title="解压zip"></a>解压zip</h1><p>主要使用ZipInputStream<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> unZipFolder(String zipFilePath, String outputDir) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        FileUtils.deleteFile(outputDir);</span><br><span class="line"></span><br><span class="line">        ZipInputStream inZip = <span class="keyword">new</span> ZipInputStream(<span class="keyword">new</span> FileInputStream(zipFilePath));</span><br><span class="line">        ZipEntry zipEntry;</span><br><span class="line">        String szName = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">while</span> ((zipEntry = inZip.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            szName = zipEntry.getName();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (szName.contains(<span class="string">"__MACOSX"</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (zipEntry.isDirectory()) &#123;</span><br><span class="line">                <span class="comment">// get the folder name of the widget</span></span><br><span class="line">                szName = szName.substring(<span class="number">0</span>, szName.length() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">File</span> folder = <span class="keyword">new</span> <span class="keyword">File</span>(outputDir + <span class="keyword">File</span>.separator + szName);</span><br><span class="line">                folder.mkdirs();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(outputDir + <span class="keyword">File</span>.separator + szName);</span><br><span class="line">                <span class="keyword">file</span>.createNewFile();</span><br><span class="line">                <span class="comment">// get the output stream of the file</span></span><br><span class="line">                FileOutputStream out = <span class="keyword">new</span> FileOutputStream(<span class="keyword">file</span>);</span><br><span class="line">                <span class="keyword">int</span> len;</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="comment">// read (len) bytes into buffer</span></span><br><span class="line">                <span class="keyword">while</span> ((len = inZip.<span class="keyword">read</span>(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// write (len) byte from buffer at the position 0</span></span><br><span class="line">                    out.<span class="keyword">write</span>(buffer, <span class="number">0</span>, len);</span><br><span class="line">                    out.flush();</span><br><span class="line">                &#125;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        inZip.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/29/adb-command/" itemprop="url">
                  adb command
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-11-29T11:15:25+08:00" content="2016-11-29">
              2016-11-29
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/11/29/adb-command/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/29/adb-command/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>常用adb命令：<br>ps: 其中adb shell <em>*</em> 的命令实际上都是 linux命令，只是前面加了adb shell就是执行一次，而不会进入到adb shell下面。</p>
<ol>
<li>获取序列号：<br>adb get-serialno</li>
<li>查看连接计算机的设备：<br>adb devices</li>
<li>重启机器：<br>adb reboot</li>
<li>重启到bootloader，即刷机模式：<br>adb reboot bootloader</li>
<li>重启到recovery，即恢复模式：<br>adb reboot recovery</li>
<li>查看log：<br>adb logcat //查看所有logadb logcat -s demo1 //输出tag 为demo1的logadb logcat &gt; log //将日志输出到log文件里面去</li>
<li>终止adb服务进程：<br>adb kill-server</li>
<li>重启adb服务进程：<br>adb start-server</li>
<li>获取机器MAC地址：<br>adb shell cat /sys/class/net/wlan0/address</li>
<li>获取CPU序列号：<br>adb shell cat /proc/cpuinfo</li>
<li>安装APK：<br>adb install <apkfile> //比如：adb install baidu.apk</apkfile></li>
<li>保留数据和缓存文件，重新安装apk：<br>adb install -r <apkfile> //比如：adb install -r baidu.apk</apkfile></li>
<li>安装apk到sd卡：<br>adb install -s <apkfile> // 比如：adb install -s baidu.apk</apkfile></li>
<li>卸载APK：<br>adb uninstall <package> //比如：adb uninstall com.baidu.search</package></li>
<li>卸载app但保留数据和缓存文件：<br>adb uninstall -k <package> //比如：adb uninstall -k com.baidu.search</package></li>
<li>启动应用：<br>adb shell am start -n <package_name>/.<activity_class_name></activity_class_name></package_name></li>
<li>查看设备cpu和内存占用情况：<br>adb shell top</li>
<li>查看占用内存前6的app：<br>adb shell top -m 6</li>
<li>刷新一次内存信息，然后返回：<br>adb shell top -n 1</li>
<li>查询各进程内存使用情况：<br>adb shell procrank</li>
<li>杀死一个进程：<br>adb shell kill [pid]</li>
<li>查看进程列表：<br>adb shell ps</li>
<li>查看指定进程状态：<br>adb shell ps -x [PID]</li>
<li>查看后台services信息：<br>adb shell service list</li>
<li>查看当前内存占用：<br>adb shell cat /proc/meminfo</li>
<li>查看IO内存分区：<br>adb shell cat /proc/iomem</li>
<li>将system分区重新挂载为可读写分区：<br>adb remount</li>
<li>从本地复制文件到设备：<br>adb push <local> <remote></remote></local></li>
<li>从设备复制文件到本地：<br>adb pull <remote> <local></local></remote></li>
<li>列出目录下的文件和文件夹，等同于dos中的dir命令：<br>adb shell ls</li>
<li>进入文件夹，等同于dos中的cd 命令：<br>adb shell cd <folder></folder></li>
<li>重命名文件：<br>adb shell rename path/oldfilename path/newfilename</li>
<li>删除system/avi.apk：<br>adb shell rm /system/avi.apk</li>
<li>删除文件夹及其下面所有文件：<br>adb shell rm -r <folder></folder></li>
<li>移动文件：<br>adb shell mv path/file newpath/file</li>
<li>设置文件权限：<br>adb shell chmod 777 /system/fonts/DroidSansFallback.ttf</li>
<li>新建文件夹：<br>adb shell mkdir path/foldelname</li>
<li>查看文件内容：<br>adb shell cat <file></file></li>
<li>查看wifi密码：<br>adb shell cat /data/misc/wifi/*.conf</li>
<li>清除log缓存：<br>adb logcat -c</li>
<li>查看bug报告：<br>adb bugreport</li>
<li>获取设备名称：<br>adb shell cat /system/build.prop</li>
<li>查看ADB帮助：<br>adb help</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/31/adb-wifi/" itemprop="url">
                  无线调试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-10-31T19:25:29+08:00" content="2016-10-31">
              2016-10-31
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/31/adb-wifi/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/31/adb-wifi/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="u6709root"><a href="#u6709root" class="headerlink" title="有root"></a>有root</h1><p>手机安装adb wifi，root授权。</p>
<h1 id="u65E0root"><a href="#u65E0root" class="headerlink" title="无root"></a>无root</h1><h2 id="u5148_u7528_u6570_u636E_u7EBF_u8FDE_u63A5_u7535_u8111_uFF0C_u6253_u5F00_u547D_u4EE4_u884C_u8F93_u5165"><a href="#u5148_u7528_u6570_u636E_u7EBF_u8FDE_u63A5_u7535_u8111_uFF0C_u6253_u5F00_u547D_u4EE4_u884C_u8F93_u5165" class="headerlink" title="先用数据线连接电脑，打开命令行输入"></a>先用数据线连接电脑，打开命令行输入</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb tcpip <span class="number">5555</span></span><br></pre></td></tr></table></figure>
<h2 id="u786E_u4FDD_u624B_u673A_u8FDE_u63A5_u7684wifi_u548C_u7535_u8111_u662F_u540C_u4E00_u4E2A_u5C40_u57DF_u7F51"><a href="#u786E_u4FDD_u624B_u673A_u8FDE_u63A5_u7684wifi_u548C_u7535_u8111_u662F_u540C_u4E00_u4E2A_u5C40_u57DF_u7F51" class="headerlink" title="确保手机连接的wifi和电脑是同一个局域网"></a>确保手机连接的wifi和电脑是同一个局域网</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb connect <span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span>.<span class="keyword">*</span></span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/21/activity-fullscreen/" itemprop="url">
                  Activity全屏切换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-10-21T17:13:06+08:00" content="2016-10-21">
              2016-10-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/21/activity-fullscreen/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/21/activity-fullscreen/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="1-_Theme"><a href="#1-_Theme" class="headerlink" title="1. Theme"></a>1. Theme</h1><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">android:</span>theme=<span class="string">"@android:style/Theme.Holo.NoActionBar.Fullscreen"</span> &gt;</span><br></pre></td></tr></table></figure>
<p>优点</p>
<ul>
<li>容易记住,不容易犯错</li>
<li>ui更加平滑，因为系统知道全屏信息</li>
</ul>
<h1 id="2-_WindowManager_flags"><a href="#2-_WindowManager_flags" class="headerlink" title="2. WindowManager flags"></a>2. WindowManager flags</h1><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FullScreen</span></span><br><span class="line"><span class="function">getWindow</span>()<span class="class">.setFlags</span>(WindowManager<span class="class">.LayoutParams</span><span class="class">.FLAG_FULLSCREEN</span>,</span><br><span class="line">                        WindowManager<span class="class">.LayoutParams</span><span class="class">.FLAG_FULLSCREEN</span>);</span><br><span class="line"><span class="comment">// Cancel</span></span><br><span class="line"><span class="function">getWindow</span>()<span class="class">.setFlags</span>(~WindowManager<span class="class">.LayoutParams</span><span class="class">.FLAG_FULLSCREEN</span>,</span><br><span class="line">                     WindowManager<span class="class">.LayoutParams</span><span class="class">.FLAG_FULLSCREEN</span>);</span><br></pre></td></tr></table></figure>
<p><strong>全屏切换时，布局会重新拉伸，造成卡顿，避免方法：</strong></p>
<ul>
<li>通过FLAG_LAYOUT_IN_SCREEN flag使全屏时布局在状态栏以下。</li>
<li>FLAG_LAYOUT_NO_LIMITS flag使全屏时布局全屏<br><strong>FLAG_LAYOUT_NO_LIMITS flag会导致系统函数getWindowVisibleDisplayFrame（主要用来计算键盘高度）失效，致命bug。</strong></li>
</ul>
<p><strong>Flag bug避免与优化</strong><br>使用marginTop避免Resize卡顿:<br>不使用有FLAG_LAYOUT_NO_LIMITS flag，给全屏展示的rootview设置一个marginTop，为负的状态栏高，切换过程看起来就像拉伸至全屏，当全屏后去掉marginTop。</p>
<p>虽然解决掉不是有FLAG_LAYOUT_NO_LIMITS 的bug，但是状态栏收缩回去会卡白一下。</p>
<h1 id="3-_SetSystemUiVisibility_28_29"><a href="#3-_SetSystemUiVisibility_28_29" class="headerlink" title="3. SetSystemUiVisibility()"></a>3. SetSystemUiVisibility()</h1><p><strong>API 16以上</strong><br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">View decorView = getWindow().getDecorView();</span><br><span class="line"><span class="comment">// Hide the status bar.</span></span><br><span class="line"><span class="keyword">int</span> uiOptions = View.SYSTEM_UI_FLAG_FULLSCREEN;</span><br><span class="line">decorView.setSystemUiVisibility(uiOptions);</span><br><span class="line"><span class="comment">// Remember that you should never show the action bar if the</span></span><br><span class="line"><span class="comment">// status bar is hidden, so hide that too if necessary.</span></span><br><span class="line">ActionBar actionBar = getActionBar();</span><br><span class="line">actionBar.<span class="keyword">hide</span>();</span><br></pre></td></tr></table></figure></p>
<p>使用SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN使布局拉伸至全屏，使用SYSTEM_UI_FLAG_LAYOUT_STABLE 避免布局resize</p>
<h3 id="Immersive_uFF08_u9000_u51FA_u5168_u5C4F_u540E_uFF0C_u72B6_u6001_u680F_u81EA_u52A8_u9690_u85CF_uFF09"><a href="#Immersive_uFF08_u9000_u51FA_u5168_u5C4F_u540E_uFF0C_u72B6_u6001_u680F_u81EA_u52A8_u9690_u85CF_uFF09" class="headerlink" title="Immersive（退出全屏后，状态栏自动隐藏）"></a><strong>Immersive</strong>（退出全屏后，状态栏自动隐藏）</h3><ul>
<li><p>SYSTEM_UI_FLAG_IMMERSIVE_STICKY <strong>API 19</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.<span class="keyword">VERSION</span>.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">    getWindow().getDecorView().setSystemUiVisibility(</span><br><span class="line">            <span class="keyword">View</span>.SYSTEM_UI_FLAG_LAYOUT_STABLE</span><br><span class="line">                    | <span class="keyword">View</span>.SYSTEM_UI_FLAG_IMMERSIVE_STICKY</span><br><span class="line">                    | <span class="keyword">View</span>.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><span class="line">                    | <span class="keyword">View</span>.SYSTEM_UI_FLAG_FULLSCREEN);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.<span class="keyword">VERSION</span>.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123;</span><br><span class="line">    getWindow().getDecorView().setSystemUiVisibility(</span><br><span class="line">            <span class="keyword">View</span>.SYSTEM_UI_FLAG_LAYOUT_STABLE</span><br><span class="line">                    | <span class="keyword">View</span>.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><span class="line">                    | <span class="keyword">View</span>.SYSTEM_UI_FLAG_FULLSCREEN);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN,</span><br><span class="line">            WindowManager.LayoutParams.FLAG_FULLSCREEN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>监听window,实现API19以下的Immersive。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onWindowFocusChanged(hasFocus);</span><br><span class="line">       <span class="comment">//Immersive</span></span><br><span class="line">       <span class="keyword">if</span> (hasFocus &amp;&amp; isFullScreen) &#123;</span><br><span class="line">           setFullScreen(isFullScreen);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>缺点：弹出键盘返回桌面都自动退出全屏。</p>
<h1 id="4-_WindowManager_u548CSetSystemUiVisibility_u6DF7_u5408_u4F7F_u7528_uFF08_u5B8C_u7F8E_u65B9_u6848_uFF09"><a href="#4-_WindowManager_u548CSetSystemUiVisibility_u6DF7_u5408_u4F7F_u7528_uFF08_u5B8C_u7F8E_u65B9_u6848_uFF09" class="headerlink" title="4. WindowManager和SetSystemUiVisibility混合使用（完美方案）"></a>4. WindowManager和SetSystemUiVisibility混合使用（完美方案）</h1><ul>
<li><p>布局全屏，避免全屏切换闪烁。</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="component">if(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.JELLY_BEAN)&#123;</span><br><span class="line">    getWindow()<span class="string">.getDecorView().setSystemUiVisibility(</span></span><br><span class="line">            View<span class="string">.SYSTEM_UI_FLAG_LAYOUT_STABLE</span></span><br><span class="line">                    | View<span class="string">.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN)</span>;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>全屏切换设置</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全屏</span></span><br><span class="line"> <span class="function">getWindow</span>()<span class="class">.setFlags</span>(WindowManager<span class="class">.LayoutParams</span><span class="class">.FLAG_FULLSCREEN</span>,</span><br><span class="line">              WindowManager<span class="class">.LayoutParams</span><span class="class">.FLAG_FULLSCREEN</span>);</span><br><span class="line"> <span class="comment">//退出全屏</span></span><br><span class="line"> <span class="function">getWindow</span>()<span class="class">.clearFlags</span>(WindowManager<span class="class">.LayoutParams</span><span class="class">.FLAG_FULLSCREEN</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>官方文档</strong><br><a href="https://developer.android.com/training/system-ui/index.html" target="_blank" rel="external">Managing the System UI</a><br><a href="https://developer.android.com/training/system-ui/status.html" target="_blank" rel="external">Hiding the Status Bar</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/23/Android-camera/" itemprop="url">
                  Android Camera
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-09-23T11:32:24+08:00" content="2016-09-23">
              2016-09-23
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/23/Android-camera/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/23/Android-camera/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="u4F7F_u7528camera_u62CD_u7167_u57FA_u672C_u6D41_u7A0B"><a href="#u4F7F_u7528camera_u62CD_u7167_u57FA_u672C_u6D41_u7A0B" class="headerlink" title="使用camera拍照基本流程"></a>使用camera拍照基本流程</h1><ol>
<li>Obtain an instance of Camera from open(int).<br>获取相机实例，open指定前后摄像头。</li>
<li>Get existing (default) settings with getParameters().<br>通过getParameters获取相机默认设置参数</li>
<li>If necessary, modify the returned Camera.Parameters object and call setParameters(Camera.Parameters).<br>setParameters设置相机参数</li>
<li>Call setDisplayOrientation(int) to ensure correct orientation of preview.<br>setDisplayOrientation设置预览图像旋转角度</li>
<li>Important: Pass a fully initialized SurfaceHolder to setPreviewDisplay(SurfaceHolder). Without a surface, the camera will be unable to start the preview.<br>显示预览到surfaceview，没有surface相机是不可以预览。</li>
<li>Important: Call startPreview() to start updating the preview surface. Preview must be started before you can take a picture.<br>startPreview开始预览，拍照前一定要预览。</li>
<li>When you want, call takePicture(Camera.ShutterCallback, Camera.PictureCallback, Camera.PictureCallback, Camera.PictureCallback) to capture a photo. Wait for the callbacks to provide the actual image data.<br>takePicture拍照</li>
<li>After taking a picture, preview display will have stopped. To take more photos, call startPreview() again first.<br>拍照后预览将会停止，重拍一定要调用startPreview。</li>
<li>Call stopPreview() to stop updating the preview surface.<br>调用stopPreview停止预览</li>
<li>Important: Call release() to release the camera for use by other applications. Applications should release the camera immediately in onPause() (and re-open() it in onResume()).<br>调用release释放相机。<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> startCamera(SurfaceTexture surface) &#123;</span><br><span class="line">      surface.setDefaultBufferSize(<span class="number">1080</span>, <span class="number">1920</span>);</span><br><span class="line"></span><br><span class="line">      Log.d(<span class="string">"lll"</span>, <span class="string">"open camera begin"</span>);</span><br><span class="line">       <span class="built_in">camera</span> = Camera.<span class="built_in">open</span>(Camera.CameraInfo.CAMERA_FACING_BACK);</span><br><span class="line">      Camera.Parameters params = <span class="built_in">camera</span>.getParameters();</span><br><span class="line">      params.setPreviewSize(<span class="number">1920</span>, <span class="number">1080</span>);</span><br><span class="line">      params.setPreviewFormat(ImageFormat.YV12);</span><br><span class="line">      <span class="built_in">camera</span>.setParameters(params);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">camera</span>.setDisplayOrientation(<span class="number">90</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="built_in">camera</span>.setPreviewTexture(surface);</span><br><span class="line">          <span class="built_in">camera</span>.startPreview();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">boolean</span>[] flag = &#123;<span class="keyword">true</span>&#125;;</span><br><span class="line">      <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[getYuvBuffer(<span class="number">1920</span>, <span class="number">1080</span>)];</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">          <span class="built_in">camera</span>.addCallbackBuffer(buffer);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">camera</span>.setPreviewCallbackWithBuffer(<span class="keyword">new</span> Camera.PreviewCallback() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> onPreviewFrame(<span class="built_in">byte</span>[] data, Camera <span class="built_in">camera</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (flag[<span class="number">0</span>]) &#123;</span><br><span class="line">                  flag[<span class="number">0</span>] = <span class="keyword">false</span>;</span><br><span class="line">                  Log.d(<span class="string">"lll"</span>, <span class="string">"open camera end"</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="built_in">camera</span>.addCallbackBuffer(data);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> getYuvBuffer(<span class="built_in">int</span> <span class="variable">width</span>, <span class="built_in">int</span> <span class="variable">height</span>) &#123;</span><br><span class="line">      <span class="comment">// stride = ALIGN(width, 16)</span></span><br><span class="line">      <span class="built_in">int</span> stride = (<span class="built_in">int</span>) Math.<span class="built_in">ceil</span>(<span class="variable">width</span> / <span class="number">16.0</span>) * <span class="number">16</span>;</span><br><span class="line">      <span class="comment">// y_size = stride * height</span></span><br><span class="line">      <span class="built_in">int</span> y_size = stride * <span class="variable">height</span>;</span><br><span class="line">      <span class="comment">// c_stride = ALIGN(stride/2, 16)</span></span><br><span class="line">      <span class="built_in">int</span> c_stride = (<span class="built_in">int</span>) Math.<span class="built_in">ceil</span>(<span class="variable">width</span> / <span class="number">32.0</span>) * <span class="number">16</span>;</span><br><span class="line">      <span class="comment">// c_size = c_stride * height/2</span></span><br><span class="line">      <span class="built_in">int</span> c_size = c_stride * <span class="variable">height</span> / <span class="number">2</span>;</span><br><span class="line">      <span class="comment">// size = y_size + c_size * 2</span></span><br><span class="line">      <span class="keyword">return</span> y_size + c_size * <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="u4F7F_u7528camera_u5F55_u89C6_u9891_u57FA_u672C_u6D41_u7A0B"><a href="#u4F7F_u7528camera_u5F55_u89C6_u9891_u57FA_u672C_u6D41_u7A0B" class="headerlink" title="使用camera录视频基本流程"></a>使用camera录视频基本流程</h1><p>Open Camera - Use the Camera.open() to get an instance of the camera object.<br>Connect Preview - Prepare a live camera image preview by connecting a SurfaceView to the camera using Camera.setPreviewDisplay().<br>Start Preview - Call Camera.startPreview() to begin displaying the live camera images.<br>Start Recording Video - The following steps must be completed in order to successfully record video:<br>Unlock the Camera - Unlock the camera for use by MediaRecorder by calling Camera.unlock().<br>Configure MediaRecorder - Call in the following MediaRecorder methods in this order. For more information, see the MediaRecorder reference documentation.<br>setCamera() - Set the camera to be used for video capture, use your application’s current instance of Camera.<br>setAudioSource() - Set the audio source, use MediaRecorder.AudioSource.CAMCORDER.<br>setVideoSource() - Set the video source, use MediaRecorder.VideoSource.CAMERA.<br>Set the video output format and encoding. For Android 2.2 (API Level 8) and higher, use the MediaRecorder.setProfile method, and get a profile instance using CamcorderProfile.get(). For versions of Android prior to 2.2, you must set the video output format and encoding parameters:<br>setOutputFormat() - Set the output format, specify the default setting or MediaRecorder.OutputFormat.MPEG_4.<br>setAudioEncoder() - Set the sound encoding type, specify the default setting or MediaRecorder.AudioEncoder.AMR_NB.<br>setVideoEncoder() - Set the video encoding type, specify the default setting or MediaRecorder.VideoEncoder.MPEG_4_SP.<br>setOutputFile() - Set the output file, use getOutputMediaFile(MEDIA_TYPE_VIDEO).toString() from the example method in the Saving Media Files section.<br>setPreviewDisplay() - Specify the SurfaceView preview layout element for your application. Use the same object you specified for Connect Preview.<br>Caution: You must call these MediaRecorder configuration methods in this order, otherwise your application will encounter errors and the recording will fail.</p>
<p>Prepare MediaRecorder - Prepare the MediaRecorder with provided configuration settings by calling MediaRecorder.prepare().<br>Start MediaRecorder - Start recording video by calling MediaRecorder.start().<br>Stop Recording Video - Call the following methods in order, to successfully complete a video recording:<br>Stop MediaRecorder - Stop recording video by calling MediaRecorder.stop().<br>Reset MediaRecorder - Optionally, remove the configuration settings from the recorder by calling MediaRecorder.reset().<br>Release MediaRecorder - Release the MediaRecorder by calling MediaRecorder.release().<br>Lock the Camera - Lock the camera so that future MediaRecorder sessions can use it by calling Camera.lock(). Starting with Android 4.0 (API level 14), this call is not required unless the MediaRecorder.prepare() call fails.<br>Stop the Preview - When your activity has finished using the camera, stop the preview using Camera.stopPreview().<br>Release Camera - Release the camera so that other applications can use it by calling Camera.release().<br>Note: It is possible to use MediaRecorder without creating a camera preview first and skip the first few steps of this process. However, since users typically prefer to see a preview before starting a recording, that process is not discussed here.</p>
<p>Tip: If your application is typically used for recording video, set setRecordingHint(boolean) to true prior to starting your preview. This setting can help reduce the time it takes to start recording.<br>/**<br>private boolean prepareVideoRecorder(){</p>
<pre><code>mCamera = getCameraInstance();
mMediaRecorder = new MediaRecorder();

// Step 1: Unlock and set camera to MediaRecorder
mCamera.unlock();
mMediaRecorder.setCamera(mCamera);

// Step 2: Set sources
mMediaRecorder.setAudioSource(MediaRecorder.AudioSource.CAMCORDER);
mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);

// Step 3: Set a CamcorderProfile (requires API Level 8 or higher)
mMediaRecorder.setProfile(CamcorderProfile.get(CamcorderProfile.QUALITY_HIGH));

// Step 4: Set output file
mMediaRecorder.setOutputFile(getOutputMediaFile(MEDIA_TYPE_VIDEO).toString());

// Step 5: Set the preview output
mMediaRecorder.setPreviewDisplay(mPreview.getHolder().getSurface());

// Step 6: Prepare configured MediaRecorder
try {
    mMediaRecorder.prepare();
} catch (IllegalStateException e) {
    Log.d(TAG, &quot;IllegalStateException preparing MediaRecorder: &quot; + e.getMessage());
    releaseMediaRecorder();
    return false;
} catch (IOException e) {
    Log.d(TAG, &quot;IOException preparing MediaRecorder: &quot; + e.getMessage());
    releaseMediaRecorder();
    return false;
}
return true;
</code></pre><p>}<br>**/</p>
<h1 id="u5F00_u53D1_u7B14_u8BB0"><a href="#u5F00_u53D1_u7B14_u8BB0" class="headerlink" title="开发笔记"></a>开发笔记</h1><h2 id="camera_orientation"><a href="#camera_orientation" class="headerlink" title="camera orientation"></a>camera orientation</h2><p>CameraInfo.orientation 是设备和相机之间的角度</p>
<ol>
<li><p>setDisplayOrientation(int) 设置预览图像旋转角度<br>只对预览起作用（详见第5条）</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="type">void</span> setCameraDisplayOrientation(<span class="type">Activity</span> activity,</span><br><span class="line">                                               <span class="type">int</span> cameraId, android.hardware.<span class="type">Camera</span> camera) &#123;</span><br><span class="line">    android.hardware.<span class="type">Camera</span>.<span class="type">CameraInfo</span> info =</span><br><span class="line">            new android.hardware.<span class="type">Camera</span>.<span class="type">CameraInfo</span>();</span><br><span class="line">    android.hardware.<span class="type">Camera</span>.getCameraInfo(cameraId, info);</span><br><span class="line">    <span class="type">int</span> rotation = activity.getWindowManager().getDefaultDisplay()</span><br><span class="line">            .getRotation();</span><br><span class="line">    <span class="type">int</span> degrees = <span class="number">0</span>;</span><br><span class="line">    switch (rotation) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Surface</span>.<span class="type">ROTATION_0</span>:</span><br><span class="line">            degrees = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Surface</span>.<span class="type">ROTATION_90</span>:</span><br><span class="line">            degrees = <span class="number">90</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Surface</span>.<span class="type">ROTATION_180</span>:</span><br><span class="line">            degrees = <span class="number">180</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Surface</span>.<span class="type">ROTATION_270</span>:</span><br><span class="line">            degrees = <span class="number">270</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="literal">result</span>;</span><br><span class="line">    <span class="keyword">if</span> (info.facing == <span class="type">Camera</span>.<span class="type">CameraInfo</span>.<span class="type">CAMERA_FACING_FRONT</span>) &#123;</span><br><span class="line">        <span class="literal">result</span> = (info.orientation + degrees) % <span class="number">360</span>;</span><br><span class="line">        <span class="literal">result</span> = (<span class="number">360</span> - <span class="literal">result</span>) % <span class="number">360</span>;  // compensate the mirror</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  // back-facing</span><br><span class="line">        <span class="literal">result</span> = (info.orientation - degrees + <span class="number">360</span>) % <span class="number">360</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    camera.setDisplayOrientation(<span class="literal">result</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>setRotation 设置拍照图片旋转角度</p>
</li>
</ol>
<p>通过设置相机setRotation旋转照片<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    * Called when the orientation of the device has changed.</span><br><span class="line">    * orientation parameter is in degrees, ranging from 0 to 359.</span><br><span class="line">    * orientation is 0 degrees when the device is oriented in its natural position,</span><br><span class="line">    * 90 degrees when its left side is at the top, 180 degrees when it is upside down, </span><br><span class="line">    * and 270 degrees when its right side is to the top.</span><br><span class="line">    * &#123;@link #ORIENTATION_UNKNOWN&#125; is returned when the device is close to flat</span><br><span class="line">    * and the orientation cannot be determined.</span><br><span class="line">    *</span><br><span class="line">    * @param orientation The new orientation of the device.</span><br><span class="line">    *</span><br><span class="line">    *  @see #ORIENTATION_UNKNOWN</span><br><span class="line">    */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOrientationChanged</span><span class="params">(<span class="keyword">int</span> orientation)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (orientation == ORIENTATION_UNKNOWN) <span class="keyword">return</span>;</span><br><span class="line">       android.hardware.Camera.CameraInfo info =</span><br><span class="line">               <span class="keyword">new</span> android.hardware.Camera.CameraInfo();</span><br><span class="line">       android.hardware.Camera.getCameraInfo(cameraId, info);</span><br><span class="line">       orientation = (orientation + <span class="number">45</span>) / <span class="number">90</span> * <span class="number">90</span>;</span><br><span class="line">       <span class="keyword">int</span> rotation = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> (info.facing == CameraInfo.CAMERA_FACING_FRONT) &#123;</span><br><span class="line">           rotation = (info.orientation - orientation + <span class="number">360</span>) % <span class="number">360</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  <span class="comment">// back-facing camera</span></span><br><span class="line">           rotation = (info.orientation + orientation) % <span class="number">360</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       mParameters.setRotation(rotation);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>拍照成功后获得bytes，从exif中获取照片旋转角度<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">ORIENTATION_NORMAL</span><br><span class="line">Constant Value: 1 (0x00000001)</span><br><span class="line"></span><br><span class="line">ORIENTATION_ROTATE_180</span><br><span class="line">Constant Value: 3 (0x00000003)</span><br><span class="line"></span><br><span class="line">ORIENTATION_ROTATE_270</span><br><span class="line">Constant Value: 8 (0x00000008)</span><br><span class="line"></span><br><span class="line">ORIENTATION_ROTATE_90</span><br><span class="line">Constant Value: 6 (0x00000006)</span><br><span class="line">**/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">ExifInterface <span class="title">getExifInterface</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (exif == <span class="keyword">null</span>) &#123;</span><br><span class="line">            exif = <span class="keyword">new</span> ExifInterface();</span><br><span class="line"></span><br><span class="line">            exif.readExif(jpegOriginal);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (exif);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">getOrientation</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ExifTag tag = getExifInterface().getTag(ExifInterface.TAG_ORIENTATION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (tag == <span class="keyword">null</span> ? -<span class="number">1</span> : tag.getValueAsInt(-1));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>旋转照片<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Matrix</span> <span class="keyword">matrix</span>=new <span class="literal">Matrix</span>();</span><br><span class="line"><span class="keyword">matrix</span>.reset();</span><br><span class="line"><span class="keyword">matrix</span>.postRotate(degrees);</span><br><span class="line">dstBmp=Bitmap.createBitmap(srcBmp, 0, 0, srcBmp.getWidth(), srcBmp.getHeight(), <span class="keyword">matrix</span>, true);</span><br></pre></td></tr></table></figure></p>
<ol>
<li>setPreviewSize设置预览图像分辨率，setPictureSize拍照分辨率<br>设置的分辨率不支持会抛异常<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取预览支持的分辨率</span></span><br><span class="line">cameraParameters.<span class="function"><span class="title">getSupportedPreviewSizes</span><span class="params">()</span></span></span><br><span class="line"><span class="comment">//获取拍照支持的分辨率 </span></span><br><span class="line">cameraParameters.<span class="function"><span class="title">getSupportedPictureSizes</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="u66DD_u5149_u8FC7_u9AD8"><a href="#u66DD_u5149_u8FC7_u9AD8" class="headerlink" title="曝光过高"></a>曝光过高</h2><p>预览帧数过低会导致部分机型曝光过高，解决方案是录视频时降低帧率。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/20/RxJava/" itemprop="url">
                  RxJava
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-09-20T15:19:32+08:00" content="2016-09-20">
              2016-09-20
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/20/RxJava/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/20/RxJava/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <h1 id="RxJava__u7684_u89C2_u5BDF_u8005_u6A21_u5F0F"><a href="#RxJava__u7684_u89C2_u5BDF_u8005_u6A21_u5F0F" class="headerlink" title="RxJava 的观察者模式"></a>RxJava 的观察者模式</h1><p>RxJava 有四个基本概念：Observable (可观察者，即被观察者)、 Observer (观察者)、 subscribe (订阅)、事件。Observable 和 Observer 通过 subscribe() 方法实现订阅关系，从而 Observable 可以在需要的时候发出事件来通知 Observer。</p>
<p>与传统观察者模式不同， RxJava 的事件回调方法除了普通事件 onNext() （相当于 onClick() / onEvent()）之外，还定义了两个特殊的事件：onCompleted() 和 onError()。</p>
<ul>
<li>onCompleted(): 事件队列完结。RxJava 不仅把每个事件单独处理，还会把它们看做一个队列。RxJava 规定，当不会再有新的onNext() 发出时，需要触发 onCompleted() 方法作为标志。</li>
<li>onError(): 事件队列异常。在事件处理过程中出异常时，onError() 会被触发，同时队列自动终止，不允许再有事件发出。</li>
<li>在一个正确运行的事件序列中, onCompleted() 和 onError() 有且只有一个，并且是事件序列中的最后一个。需要注意的是，onCompleted() 和 onError() 二者也是互斥的，即在队列中调用了其中一个，就不应该再调用另一个。</li>
</ul>
<p>create() 方法是 RxJava 最基本的创造事件序列的方法。基于这个方法， RxJava 还提供了一些方法用来快捷创建事件队列，例如：</p>
<ul>
<li>just(T…): 将传入的参数依次发送出来。<br>Observable observable = Observable.just(“Hello”, “Hi”, “Aloha”);</li>
<li>from(T[]) / from(Iterable&lt;? extends T&gt;) : 将传入的数组或 Iterable 拆分成具体对象后，依次发送出来。</li>
</ul>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/09/20/RxJava/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/19/ViewPager的数据更新/" itemprop="url">
                  ViewPager的数据更新
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-09-19T11:11:52+08:00" content="2016-09-19">
              2016-09-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/19/ViewPager的数据更新/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/19/ViewPager的数据更新/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <p>ViewPager的更新通过的PagerAdapter中的notifyDataSetChanged方法，可以增加、删除或排序，但不可以像RecycleView更新view。<br><strong>官方文档：</strong><br>PagerAdapter supports data set changes. Data set changes must occur on the main thread and must end with a call to {@link #notifyDataSetChanged()} similar to AdapterView adapters derived from {@link android.widget.BaseAdapter}. A data set change may involve pages being added, removed, or changing position. The ViewPager will keep the current page active provided the adapter implements the method {@link #getItemPosition(Object)}.</p>
<p>更新后ViewPager是否保持当前页存活，通过adapter实现getItemPosition方法进行判断。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Called when the host view is attempting to determine if an item's position</span><br><span class="line"> <span class="keyword">*</span> has changed. Returns &#123;<span class="comment">@link #POSITION_UNCHANGED&#125; if the position of the given</span></span><br><span class="line"> <span class="keyword">*</span> item has not changed or &#123;<span class="comment">@link #POSITION_NONE&#125; if the item is no longer present</span></span><br><span class="line"> <span class="keyword">*</span> in the adapter.</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="variable">&lt;p&gt;</span>The default implementation assumes that items will never</span><br><span class="line"> <span class="keyword">*</span> change position and always returns &#123;<span class="comment">@link #POSITION_UNCHANGED&#125;.</span></span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param object Object representing an item, previously returned by a call to</span></span><br><span class="line"> <span class="keyword">*</span>               &#123;<span class="comment">@link #instantiateItem(View, int)&#125;.</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@return object's new position index from [0, &#123;@link #getCount()&#125;),</span></span><br><span class="line"> <span class="keyword">*</span>         &#123;<span class="comment">@link #POSITION_UNCHANGED&#125; if the object's position has not changed,</span></span><br><span class="line"> <span class="keyword">*</span>         or &#123;<span class="comment">@link #POSITION_NONE&#125; if the item is no longer present.</span></span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">public int getItemPosition(Object object) &#123;</span><br><span class="line">    return POSITION_UNCHANGED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>POSITION_UNCHANGED不更新，POSITION_NONE更新。<br>所以重写getItemPosition方法，返回POSITION_NONE，可以先实现通过notifyDataSetChanged进行页面更新。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/09/19/ViewPager的数据更新/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Shine Lee" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Shine Lee</p>
        </div>
        <p class="site-description motion-element" itemprop="description">生命不息，折腾不止！！！</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">32</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">2</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">9</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ljyao" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3715142347" target="_blank">
                  
                    <i class="fa fa-globe"></i> weibo
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shine Lee</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"shinelee"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
